<html>
  <head>
    <title>ReefLight</title>
    <script src='jquery-3.3.1.js'></script>
    <script>var jsonBak</script>
    <link rel='stylesheet' href='style.css'/>
  </head>
  <body>
    <table id='channel_table' ></table>
    <script>
    function load_data() {    
      jQuery.getJSON('data.json', 
      function(json){
          console.log('received JSON:');
          console.log(json);
          
          jsonBak = json;
        
          $('#channel_table tbody').remove(); 
          var tBody = $('<tbody />').appendTo($('#channel_table'));      
          for(c=0; c<json.channels.length; c++) {
            channel = json.channels[c]
            val = channel.percentage;
            if(channel.manual) val = channel.manual_percentage;
            var row = $('<tr />').appendTo(tBody);
            // name
            $('<td />', {text: channel.name}).appendTo(row);
            // manual mode checkbox
            var input = $('<input />', {
              'type':'checkbox', 
              'id':'checkbox_'+c,
              'checked':channel.manual,
              'onclick':'update('+c+',false,true)'
            })
            $('<td />', {text: '<input type="text">'})
              .html(input)
            .appendTo(row);
            // slider
            $('<td />', {text: '<input type="text">'})
              .html($('<input />', {
                'type':'range', 
                'id':'slider_'+c, 
                'value':+val,
                'onchange':'update('+c+',true,false)'
              }))
            .appendTo(row);

          }
        })
        .fail(function(jqXHR, textStatus, errorThrown) { 
          alert('getJSON request failed! ' + textStatus); 
        });
    }  
      
    function update(c, slider = false, checkbox = false) {
      json = jsonBak;
      if(slider) {
        console.log('change in slider '+c)
        $('#checkbox_'+c).prop('checked', true)
      }
      if(checkbox) {
        console.log('change in checkbox '+c);
      }
        
      json['channels'][c]['manual'] = $('#checkbox_'+c).prop('checked')
      json['channels'][c]['manual_percentage'] = parseFloat($('#slider_'+c).val());

      var xmlhttp = new XMLHttpRequest();
      xmlhttp.open("POST", "/saveManual");
      xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      xmlhttp.send(JSON.stringify(json));
        
      load_data(); 
      
    }
    load_data();
    </script>
  </body>
</html>
